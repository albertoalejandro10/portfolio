import{f as E,j as ie,y as oe,R as S,P as N,V as K,Q as se,W as ae,U as v,B as V,T as q,Y as re,A,aa as ce}from"./BKZ8r7iz.js";import{an as T,ao as z,_ as de,ap as U,aq as D,w as H,ar as le,o as W,c as J,m as pe,as as ue,at as fe,b as Q}from"./BgnTuvds.js";import{loadDatabaseAdapter as P}from"./DqmaNS9T.js";import{j as Z,p as he,d as ve,m as k,h as we,c as b}from"./CERBcUqK.js";import"./CkGsYvhA.js";const me=(e,n)=>{const t=e.__vccOpts||e;for(const[r,c]of n)t[r]=c;return t},ge={key:0},ye={key:0},xe={id:"__preview_loader"},_e={__name:"ContentPreviewMode",props:{previewToken:{type:String,required:!0},api:{type:String,required:!0},initializePreview:{type:Function,required:!0}},setup(e){const n=e,t=["__nuxt_preview","__preview_enabled"],r=T(),c=z(),i=E(!0),l=E(!1),o=E(!1),d=E("");let a;const u=async()=>{U("previewToken").value="",window.sessionStorage.removeItem("previewToken"),window.sessionStorage.removeItem("previewAPI"),await c.replace({query:{preview:void 0}}),window.location.reload()},y=async _=>{await n.initializePreview(_),U("previewToken").value&&(o.value=!0,await c.replace({query:{}}),r.callHook("nuxt-content:preview:ready"),window.parent&&window.self!==window.parent&&a.disconnect())};return ie(async()=>{a=(await de(()=>import("./C_kUcf19.js"),[],import.meta.url)).connect(`${n.api}/preview`,{transports:["websocket","polling"],auth:{token:n.previewToken}});let s;a.on("connect",()=>{s=setTimeout(()=>{o.value||(s=setTimeout(()=>{d.value="Preview sync timed out",o.value=!1},3e4),a.emit("draft:requestSync"))},3e4)});const p=()=>{s&&(clearTimeout(s),s=null)};a.on("draft:sync",async f=>{if(p(),!f){try{a.once("draft:ready",()=>{a.emit("draft:requestSync")}),await $fetch("api/projects/preview/sync",{baseURL:n.api,method:"POST",params:{token:n.previewToken}})}catch(h){p(),h.response.status===404?(d.value="Preview draft not found",o.value=!1):(d.value="An error occurred while syncing preview",o.value=!1)}return}y(f)}),a.on("draft:unauthorized",()=>{p(),d.value="Unauthorized preview",o.value=!1}),a.on("disconnect",()=>{p()}),document.body.classList.add(...t)}),oe(()=>{document.body.classList.remove(...t)}),(_,s)=>(A(),S("div",null,[i.value?(A(),S("div",{key:0,id:"__nuxt_preview",class:se({__preview_ready:o.value,__preview_refreshing:l.value})},[o.value?(A(),S(ae,{key:0},[s[0]||(s[0]=v("svg",{viewBox:"0 0 90 90",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[v("path",{d:"M50.0016 71.0999h29.2561c.9293.0001 1.8422-.241 2.6469-.6992.8047-.4582 1.4729-1.1173 1.9373-1.9109.4645-.7936.7088-1.6939.7083-2.6102-.0004-.9162-.2455-1.8163-.7106-2.6095L64.192 29.713c-.4644-.7934-1.1325-1.4523-1.937-1.9105-.8046-.4581-1.7173-.6993-2.6463-.6993-.9291 0-1.8418.2412-2.6463.6993-.8046.4582-1.4726 1.1171-1.937 1.9105l-5.0238 8.5861-9.8224-16.7898c-.4648-.7934-1.1332-1.4522-1.938-1.9102-.8047-.4581-1.7176-.6992-2.6468-.6992-.9292 0-1.842.2411-2.6468.6992-.8048.458-1.4731 1.1168-1.9379 1.9102L6.56062 63.2701c-.46512.7932-.71021 1.6933-.71061 2.6095-.00041.9163.24389 1.8166.70831 2.6102.46443.7936 1.1326 1.4527 1.93732 1.9109.80473.4582 1.71766.6993 2.64686.6992h18.3646c7.2763 0 12.6422-3.1516 16.3345-9.3002l8.9642-15.3081 4.8015-8.1925 14.4099 24.6083H54.8058l-4.8042 8.1925ZM29.2077 62.899l-12.8161-.0028L35.603 30.0869l9.5857 16.4047-6.418 10.9645c-2.4521 3.9894-5.2377 5.4429-9.563 5.4429Z",fill:"currentColor"})],-1)),s[1]||(s[1]=v("span",null,"Preview enabled",-1)),v("button",{onClick:u}," Close ")],64)):N("",!0)],2)):N("",!0),K(q,{name:"preview-loading"},{default:V(()=>[i.value&&!o.value&&!d.value?(A(),S("div",ge,[s[4]||(s[4]=v("div",{id:"__preview_background"},null,-1)),v("div",{id:"__preview_loader"},[s[2]||(s[2]=v("svg",{id:"__preview_loading_icon",width:"32",height:"32",viewBox:"0 0 24 24"},[v("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 0 0 4.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 0 1-15.357-2m15.357 2H15"})],-1)),s[3]||(s[3]=v("p",null,"Initializing the preview...",-1)),v("button",{onClick:u}," Cancel ")])])):N("",!0)]),_:1}),K(q,{name:"preview-loading"},{default:V(()=>[d.value?(A(),S("div",ye,[s[5]||(s[5]=v("div",{id:"__preview_background"},null,-1)),v("div",xe,[v("p",null,re(d.value),1),v("button",{onClick:u}," Exit preview ")])])):N("",!0)]),_:1})]))}},Ce=me(_e,[["__scopeId","data-v-463f6858"]]),g={appConfig:"app.config.ts",appConfigV4:"app/app.config.ts",nuxtConfig:"nuxt.config.ts"};function I(e){return e?.startsWith("content/")?e.split("/").slice(1).join("/"):D(e)}function x(e,n=!1){return e&&(n?H(e.replace(/\/\d+\./,"/")):D(e.replace(/^\d+\./,"")))}function $(e){const n=I(e);return Z(ve(n),he(n).name)}function Pe(e=[],n,t){const r=[...n||[]],c=[...t||[]],i=JSON.parse(JSON.stringify(e));for(const o of r)if(o.new)i.push({path:o.path,parsed:o.parsed});else if(o.oldPath)if(c.splice(c.findIndex(a=>a.path===o.oldPath),1),r.find(a=>a.path===o.oldPath))i.push({path:o.path,parsed:o.parsed});else{const a=i.find(u=>u.path===o.oldPath);a&&(a.path=o.path,o.parsed?a.parsed=o.parsed:o.pathMeta&&["_file","_path","_id","_locale"].forEach(u=>{a.parsed[u]=o.pathMeta[u]}))}else{const d=i.find(a=>a.path===o.path);d?Object.assign(d,{path:o.path,parsed:o.parsed}):i.push({path:o.path,parsed:o.parsed})}for(const o of c)i.splice(i.findIndex(d=>d.path===o.path),1);const l=new Intl.Collator(void 0,{numeric:!0});return i.sort((o,d)=>l.compare(o.path,d.path)),i}const ke=le((e,n,t)=>{if(Array.isArray(e[n])&&Array.isArray(t))return e[n]=t,!0}),be=e=>{let n;return t=>(n||(n=e()),n)};function Y(e,n){for(const t in e){const r=n[t];t in n||delete e[t],r!==null&&typeof r=="object"&&Y(e[t],n[t])}}function G(e,n){for(const t in n){const r=n[t];if(r==="_DELETED_"){delete e[t];continue}r!==null&&typeof r=="object"?Array.isArray(r)&&Array.isArray(e[t])?e[t]=r:(e[t]=e[t]||{},G(e[t],r)):e[t]=r}}function X(e){const[n,...t]=e.include.includes("*")?e.include.split("*"):["",e.include];return{fixed:n||"",dynamic:"*"+t.join("*")}}const ee=(e,n,t)=>{const{fixed:r}=X(t);if(!e.parsed)return;const c=x(r||""),i=x(t?.prefix||"",!0),l=e.parsed._path.substring(c.length),o=Z(i,l),d={id:e.parsed._id,stem:e.parsed._stem,meta:{},extension:e.parsed._extension,path:o},a=n.schema.definitions[n.name].properties;return Object.keys(e.parsed).forEach(u=>{u in a?d[u]=e.parsed[u]:d.meta[u]=e.parsed[u]}),d};function Se(e){const n=Object.values(e.definitions)[0]?.properties||{},t=new Set([n.id?"id":void 0,n.title?"title":void 0,...Object.keys(n).sort()].filter(Boolean));return Array.from(t)}const R=(e,n)=>{let t;return{collection:Object.values(n).find(c=>{if(!c.source||c.source.length===0)return;const i=I(e);return(i==="/"?["index.yml","index.yaml","index.md","index.json"]:[i]).some(o=>(t=c.source.find(d=>{const a=k(o,d.include),u=d.exclude?.some(y=>k(o,y));return a&&!u}),t))}),matchedSource:t}},Ae=(e,n)=>{let t;return{collection:Object.values(n).find(c=>{if(!(!c.source||c.source.length===0))return t=c.source.find(i=>{if(!i.prefix)return;const l=x(i.prefix,!0);if(!e.startsWith(l))return;if(e==="/"){const p=["index.yml","index.yaml","index.md","index.json"];return(e==="/"?p:p.map(h=>D(W(l,h)))).some(h=>{const w=k(h,x(i.include)),m=i.exclude?.some(C=>k(h,x(C)));return w&&!m})}const{fixed:o}=X(i),d=x(o||""),a=e.substring(l.length),u=W(d,a),y=p=>p.replace(/\.[^/.]+$/,""),_=k(u,y(x(i.include))),s=i.exclude?.some(p=>k(u,y(x(p))));return _&&!s}),t}),matchedSource:t}};function te(e,n){const t=Ne(e,n);let r=0;return`INSERT INTO ${e.tableName} VALUES (${"?, ".repeat(t.length).slice(0,-2)})`.replace(/\?/g,()=>t[r++])}function Ee(e,n,t){const r=ne(e,n),c=te(e,t);return`${r}; ${c}`}function ne(e,n){return`DELETE FROM ${e.tableName} WHERE stem = '${n}';`}function B(e,n,t){return`SELECT * FROM ${e.tableName} WHERE ${n} = '${t}';`}function Ne(e,n){const t=[],r=e.schema.definitions[e.name].properties;return Se(e.schema).forEach(i=>{const l=r[i],o=e.fields[i],d=l?.default!==void 0?l.default:"NULL",a=typeof n[i]<"u"?n[i]:d;o==="json"?t.push(`'${JSON.stringify(a).replace(/'/g,"''")}'`):o==="string"||["string","enum"].includes(l.type)?["data","datetime"].includes(l.format)?t.push(a!=="NULL"?`'${new Date(a).toISOString()}'`:d):t.push(`'${String(a).replace(/\n/g,"\\n").replace(/'/g,"''")}'`):o==="boolean"?t.push(a!=="NULL"?!!a:a):t.push(a)}),t.push(`'${we(t)}'`),t}const Re=["https://nuxt.studio","https://dev.nuxt.studio"],F=E(!1),j=be(()=>JSON.parse(JSON.stringify(Q()))),Ie=async e=>{const n=Pe(e.files,e.additions,e.deletions),t=n.filter(c=>![g.appConfig,g.appConfigV4,g.nuxtConfig].includes(c.path));for(const c of Object.values(b))await P(c.name).exec(c.tableDefinition);for(const c of t)await Te(b,c);const r=n.find(c=>[g.appConfig,g.appConfigV4].includes(c.path));r&&M(r.parsed),ue(),F.value=!0},Te=async(e,n)=>{const{collection:t,matchedSource:r}=R(n.path,e);if(!t||!r){console.warn(`Content Preview: collection not found for file: ${n.path}, skipping insertion.`);return}const c=P(t.name),i=ee(n,t,r),l=te(t,i);await c.exec(l)},M=e=>{const n=T(),t=fe(n,Q);G(t,ke(e||{},j)),e||Y(t,j)};function Ve(){const e=J().public.preview||{},n=window.sessionStorage.getItem("previewToken"),t=document.createElement("div");t.id="__nuxt_preview_wrapper",document.body.appendChild(t),ce(Ce,{previewToken:n,api:window.sessionStorage.getItem("previewAPI")||e?.api,initializePreview:Ie}).mount(t)}function qe(){const e=T(),n=J().public.preview;if(!window.parent||window.self===window.parent)return;const t=z(),r=pe();window.addEventListener("keydown",i=>{(i.metaKey||i.ctrlKey||i.altKey||i.shiftKey)&&window.parent.postMessage({type:"nuxt-content:preview:keydown",payload:{key:i.key,metaKey:i.metaKey,ctrlKey:i.ctrlKey,shiftKey:i.shiftKey,altKey:i.altKey}},"*")}),window.addEventListener("message",async i=>{if(!F.value)return;const l=n?.iframeMessagingAllowedOrigins?.split(",").map(s=>s.trim())||[];if(!["http://localhost:3000",...Re,...l].includes(i.origin))return;const{type:o,payload:d={},navigate:a}=i.data||{};switch(o){case"nuxt-content:editor:file-selected":{await u(d.path);break}case"nuxt-content:editor:file-changed":case"nuxt-content:editor:media-changed":{const{additions:s=[],deletions:p=[]}=d;for(const f of s)await y(f,a);for(const f of p)await _(f.path);Le();break}case"nuxt-content:config:file-changed":{const{additions:s=[],deletions:p=[]}=d,f=s.find(w=>[g.appConfig,g.appConfigV4].includes(w.path));f&&M(f?.parsed),p.find(w=>[g.appConfig,g.appConfigV4].includes(w.path))&&M(void 0)}}async function u(s){if(!s)return;const{collection:p}=R(I(s),b);if(!p){console.warn(`Content Preview: collection not found for file: ${s}, skipping navigation.`);return}if(p.type!=="page")return;const f=P(p.name),h=$(s),w=B(p,"stem",h),m=await f.first(w);if(!m||!m.path)return;const C=t.resolve(m.path);!C||!C.matched||C.matched.length===0||m.path!==r.path&&t.push(m.path)}async function y(s,p){const{collection:f,matchedSource:h}=R(s.path,b);if(!f||!h){console.warn(`Content Preview: collection not found for file: ${s.path}, skipping update.`);return}const w=$(s.path),m=ee({path:s.path,parsed:s.parsed},f,h),C=Ee(f,w,m);if(await P(f.name).exec(C),f.type!=="page"||!s.pathRoute)return;const L=H(s.pathRoute);if(p&&L!==r.path){const O=t.resolve(L);if(!O||!O.matched||O.matched.length===0)return;t.push(L)}}async function _(s){const{collection:p}=R(I(s),b);if(!p){console.warn(`Content Preview: collection not found for file: ${s}, skipping deletion.`);return}const f=$(s),h=ne(p,f);await P(p.name).exec(h)}});async function c(){if(!F.value)return;const i=r.path,{collection:l}=Ae(i,b);if(!l||l.type!=="page"){window.sendNavigateMessageInPreview(i,!1);return}const o=P(l.name),d=B(l,"path",i),a=await o.first(d);window.sendNavigateMessageInPreview(i,!!a?.path)}e.hook("page:finish",()=>{c()}),e.hook("nuxt-content:preview:ready",()=>{window.parent.postMessage({type:"nuxt-content:preview:ready"},"*")}),window.sendNavigateMessageInPreview=(i,l)=>{window.parent.postMessage({type:"nuxt-content:preview:navigate",payload:{path:i,navigate:l}},"*")}}async function Le(){await T().hooks.callHookParallel("app:data:refresh")}export{qe as initIframeCommunication,Ve as mountPreviewUI};
